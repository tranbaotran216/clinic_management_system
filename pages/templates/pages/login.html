{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập - Medical Clinic</title>
    <!-- Sửa đường dẫn CSS -->
    <link rel="stylesheet" href="{% static 'pages/style.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="login-page">
    <main class="login-main-content">
        <div class="login-card-container">
            <div class="login-illustration">
                <!-- Sửa đường dẫn ảnh -->
                <img src="{% static 'pages/images/docnpatient.png' %}" alt="Bác sĩ và bệnh nhân">
            </div>
            <div class="login-form-content">
                <h2>Chào mừng bạn đến với <span style="color: #7B66FF;">Medical Clinic!</span></h2>
                <h3>Đăng nhập</h3>
                <!-- Sửa Form: Thêm id để JS có thể bắt sự kiện, thêm CSRF token -->
                <form class="login-form" id="loginForm" method="POST">
                    
                    {% csrf_token %} <!-- Bắt buộc phải có cho bảo mật của Django -->

                    <div class="form-group">
                        <label for="username" class="sr-only">Tên đăng nhập</label>
                        <input type="text" id="username" name="username" placeholder="Tên đăng nhập*" required>
                    </div>
                    <div class="form-group">
                        <label for="password" class="sr-only">Mật khẩu</label>
                        <input type="password" id="password" name="password" placeholder="Mật khẩu*" required>
                    </div>

                    <!-- Thêm một div để hiển thị thông báo lỗi -->
                    <div id="errorMessage" style="color: red; margin-bottom: 15px; text-align: center;"></div>

                    <div class="form-options">
                        <div class="remember-me">
                            <input type="checkbox" id="remember-me" name="remember-me">
                            <label for="remember-me">Lưu mật khẩu</label>
                        </div>
                        <a href="{% url 'pages:reset_password' account_id=1 %}" class="forgot-password">Quên mật khẩu?</a>

                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" onclick="window.location.href='{% url 'pages:index' %}'">Hủy</button>
                        <button type="submit" class="btn btn-login-submit">Đăng nhập</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- === PHẦN SCRIPT ĐỂ GỌI API === -->
    <script>
        // Lắng nghe sự kiện khi form được submit
        document.getElementById('loginForm').addEventListener('submit', async function(event) {
            // Ngăn chặn hành vi mặc định của form (tải lại trang)
            event.preventDefault();

            // Lấy các giá trị từ form
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessageDiv = document.getElementById('errorMessage');

            // Xóa thông báo lỗi cũ
            errorMessageDiv.textContent = '';

            try {
                // Gửi yêu cầu POST đến API login của bạn
                const response = await fetch('/api/login/', { // API endpoint của bạn
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Lấy CSRF token từ form và thêm vào header
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify({
                        ten_dang_nhap: username,
                        password: password,
                    }),
                });

                // Chuyển đổi phản hồi từ server sang JSON
                const data = await response.json();

                if (response.ok) {
                    console.log('Đăng nhập thành công!', data);
                    
                    localStorage.setItem('accessToken', data.access);
                    localStorage.setItem('user', JSON.stringify(data.user));

                    // ===================================================
                    // === THAY ĐỔI QUAN TRỌNG NHẤT NẰM Ở ĐÂY           ===
                    // ===================================================
                    // Chuyển hướng đến một URL bắt đầu bằng /app/
                    // để kích hoạt ứng dụng React
                    window.location.href = "/dashboard/";
                    // ===================================================

                }  else {
                    // Nếu có lỗi từ server (ví dụ: sai mật khẩu)
                    console.error('Lỗi đăng nhập:', data);
                    errorMessageDiv.textContent = data.error || 'Thông tin đăng nhập không hợp lệ.';
                }

            } catch (error) {
                // Nếu có lỗi mạng hoặc lỗi không xác định
                console.error('Có lỗi xảy ra:', error);
                errorMessageDiv.textContent = 'Không thể kết nối đến server. Vui lòng thử lại.';
            }
        });
    </script>
</body>
</html>