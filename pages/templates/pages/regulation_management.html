{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Quy Định</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV6F" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'pages/style.css' %}">
</head>
<body class="regulation-management-page">
    <div class="main-content-wrapper">
        <div class="top-page-layout">
            <div class="breadcrumb">
                <a href="{% url 'pages:admin_dashboard' %}">
                    <img src="{% static 'pages/images/home.png' %}" class="breadcrumb-icon purple-tint">
                </a>
                <img src="{% static 'pages/images/arrow.png' %}" class="breadcrumb-arrow-img purple-tint">
                <span>Quản lý quy định</span>
            </div>
        </div>

        <!-- PHẦN 1: QUY ĐỊNH CHUNG -->
        <div class="regulation-card">
            <div class="regulation-grid">
                <div class="regulation-column">
                    <div class="regulation-item">
                        <label for="MAX_PATIENTS_PER_DAY">Số lượng bệnh nhân tối đa trong ngày</label>
                        <div class="input-with-icon">
                            <input type="number" id="MAX_PATIENTS_PER_DAY" value="..." class="regulation-input" data-key="MAX_PATIENTS_PER_DAY" placeholder="Đang tải...">
                            <img src="{% static 'pages/images/note.png' %}" class="note-icon save-regulation-btn" title="Lưu thay đổi">
                        </div>
                    </div>
                </div>
                <div class="regulation-column">
                    <div class="regulation-item">
                        <label for="BASE_EXAMINATION_FEE">Tiền khám (VND)</label>
                        <div class="input-with-icon">
                            <input type="number" id="BASE_EXAMINATION_FEE" value="..." class="regulation-input" data-key="BASE_EXAMINATION_FEE" placeholder="Đang tải...">
                            <img src="{% static 'pages/images/note.png' %}" class="note-icon save-regulation-btn" title="Lưu thay đổi">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PHẦN 2: DANH MỤC LOẠI BỆNH -->
        <div class="disease-category-section">
            <div class="section-header">
                <h2 class="section-title">Danh mục loại bệnh</h2>
                <button class="btn btn-add-disease" id="addDiseaseBtn">
                    <a href="{% url 'pages:add_disease_type' %}" class="btn-link">
                        <i class="fa-solid fa-plus"></i> Thêm loại bệnh
                    </a>
                </button>
            </div>
            <div class="table-responsive">
                <table class="disease-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Loại bệnh</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="diseaseTableBody">
                        <tr><td colspan="3" style="text-align: center;">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PHẦN 3: DANH MỤC THUỐC -->
        <div class="medicine-management-container">
            <div class="header-section">
                <h2 class="section-title">Danh mục thuốc</h2>
                <button class="btn btn-add-disease" onclick="window.location.href='{% url 'pages:add_drugs' %}'">
                    <i class="fa-solid fa-plus"></i> Thêm thuốc
                </button>
            </div>
            <div class="table-responsive">
                <table class="disease-table medicine-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên thuốc</th>
                            <th>Đơn vị tính</th>
                            <th>Số lượng</th>
                            <th>Hạn sử dụng</th>
                            <th>Đơn giá (VND)</th>
                            <th class="action-column"></th>
                        </tr>
                    </thead>
                    <tbody id="medicineTableBody">
                        <tr><td colspan="7" style="text-align: center;">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- DANH MỤC CÁCH DÙNG THUỐC -->
        <div class="medicine-management-container">
            <div class="header-section">
                <h2 class="section-title">Danh mục cách dùng thuốc</h2>
                <button class="btn btn-add-disease" id="addUsageBtn">
                    <a href="{% url 'pages:add_usage' %}" class="btn-link">
                        <i class="fa-solid fa-plus"></i> Thêm cách dùng
                    </a>
                </button>
            </div>
            <div class="table-responsive">
                <table class="disease-table usage-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Cách dùng</th>
                            <th>Mô tả</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="usageTableBody">
                        <tr><td colspan="4" style="text-align: center;">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- DANH MỤC ĐƠN VỊ TÍNH -->
        <div class="medicine-management-container">
            <div class="header-section">
                <h2 class="section-title">Danh mục đơn vị tính</h2>
                <button class="btn btn-add-disease" id="addUnitBtn">
                    <i class="fa-solid fa-plus"></i> Thêm đơn vị tính
                </button>
            </div>
            <div class="table-responsive">
                <table class="disease-table unit-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Đơn vị tính</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="unitTableBody">
                        <tr><td colspan="3" style="text-align: center;">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {
                window.location.href = "{% url 'pages:login' %}";
                return;
            }

            // Hàm gọi API chung
            const apiRequest = async (url, method = 'GET', body = null) => {
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                };
                const config = { method, headers };
                if (body) {
                    config.body = JSON.stringify(body);
                    headers['X-CSRFToken'] = '{{ csrf_token }}';
                }
                const response = await fetch(url, config);
                if (response.status === 401) {
                    window.location.href = "{% url 'pages:login' %}";
                    return null;
                }
                return response;
            };

            // === PHẦN 1: XỬ LÝ QUY ĐỊNH ===
            async function fetchRegulations() {
                const response = await apiRequest('/api/quy-dinh-value/');
                if (response && response.ok) {
                    const regulations = await response.json();
                    regulations.forEach(reg => {
                        const inputElement = document.getElementById(reg.ma_quy_dinh);
                        if (inputElement) {
                            inputElement.value = reg.gia_tri;
                        }
                    });
                }
            }

            document.querySelectorAll('.save-regulation-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const inputElement = this.previousElementSibling;
                    const regulationKey = inputElement.dataset.key;
                    const newValue = inputElement.value;
                    const response = await apiRequest(`/api/quy-dinh-value/${regulationKey}/`, 'PUT', { gia_tri: newValue });
                    if (response && response.ok) {
                        alert('Cập nhật quy định thành công!');
                        inputElement.style.border = '2px solid green';
                        setTimeout(() => { inputElement.style.border = ''; }, 2000);
                    } else {
                        alert('Cập nhật thất bại!');
                        inputElement.style.border = '2px solid red';
                        setTimeout(() => { inputElement.style.border = ''; }, 2000);
                    }
                });
            });

            // === PHẦN 2: XỬ LÝ LOẠI BỆNH ===
            const diseaseTableBody = document.getElementById('diseaseTableBody');

            async function fetchDiseases() {
                const response = await apiRequest('/api/loai-benh/');
                if (response && response.ok) {
                    const diseases = await response.json();
                    diseaseTableBody.innerHTML = '';
                    diseases.forEach((disease, index) => {
                        const row = `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${disease.ten_loai_benh}</td>
                                <td class="action-column">
                                    <img src="{% static 'pages/images/trashcan.png' %}" class="fa-solid fa-trash-can delete-icon" data-id="${disease.id}" title="Xóa">
                                </td>
                            </tr>
                        `;
                        diseaseTableBody.insertAdjacentHTML('beforeend', row);
                    });
                    if (diseases.length === 0) {
                        diseaseTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Không có dữ liệu.</td></tr>`;
                    }
                } else {
                    diseaseTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:red;">Lỗi tải dữ liệu.</td></tr>`;
                }
            }

            document.getElementById('addDiseaseBtn').addEventListener('click', async () => {
                const diseaseName = prompt("Nhập tên loại bệnh mới:");
                if (diseaseName && diseaseName.trim() !== '') {
                    const response = await apiRequest('/api/loai-benh/', 'POST', { ten_loai_benh: diseaseName });
                    if (response && response.ok) {
                        alert('Thêm loại bệnh thành công!');
                        fetchDiseases();
                    } else {
                        alert('Thêm thất bại!');
                    }
                }
            });

            diseaseTableBody.addEventListener('click', async function(event) {
                if (event.target.classList.contains('delete-icon')) {
                    const diseaseId = event.target.dataset.id;
                    if (confirm(`Bạn có chắc chắn muốn xóa loại bệnh này không?`)) {
                        const response = await apiRequest(`/api/loai-benh/${diseaseId}/`, 'DELETE');
                        if (response && response.status === 204) {
                            alert('Xóa thành công!');
                            fetchDiseases();
                        } else {
                            alert('Xóa thất bại. Có thể loại bệnh này đang được sử dụng.');
                        }
                    }
                }
            });

            // Khởi tạo dữ liệu
            fetchRegulations();
            fetchDiseases();
            // Bạn có thể gọi các hàm fetch cho các phần khác ở đây
        });
    </script>
</body>
</html>
