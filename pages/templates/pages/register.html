{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÄÄƒng kÃ½ khÃ¡m bá»‡nh - Medical Clinic</title>
    <!-- Sá»­a Ä‘Æ°á»ng dáº«n CSS -->
    <link rel="stylesheet" href="{% static 'pages/style.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="register-page">

    <main class="register-main-content">
        <div class="register-card-container">
            <div class="register-illustration">
                <!-- Sá»­a Ä‘Æ°á»ng dáº«n áº£nh -->
                <img src="{% static 'pages/images/docnpatient2.png' %}" alt="BÃ¡c sÄ© khÃ¡m bá»‡nh">
            </div>
            <div class="register-form-content">
                <h2>ÄÄƒng kÃ½ khÃ¡m bá»‡nh</h2>
                <p class="form-description">Nháº­p cÃ¡c thÃ´ng tin dÆ°á»›i Ä‘Ã¢y Ä‘á»ƒ Ä‘Äƒng kÃ½ khÃ¡m bá»‡nh</p>
                <!-- ThÃªm id vÃ  sá»­a tÃªn cÃ¡c trÆ°á»ng input -->
                <form id="registerForm" class="register-form" method="POST">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="ho_ten" class="form-label">Há» vÃ  tÃªn:<span class="required-star">*</span></label>
                        <input type="text" id="ho_ten" name="ho_ten" placeholder="Há» vÃ  tÃªn*" required>
                    </div>
                    <div class="form-group">
                        <label for="dia_chi" class="form-label">Äá»‹a chá»‰:<span class="required-star">*</span></label>
                        <input type="text" id="dia_chi" name="dia_chi" placeholder="Äá»‹a chá»‰*" required>
                    </div>
                    <div class="form-group custom-select-wrapper">
                        <label for="gioi_tinh" class="form-label">Giá»›i tÃ­nh:<span class="required-star">*</span></label>
                        <select id="gioi_tinh" name="gioi_tinh" required>
                            <option value="" disabled selected hidden>Giá»›i tÃ­nh*</option>
                            <option value="M">Nam</option>
                            <option value="F">Ná»¯</option>
                        </select>
                        <span class="custom-select-arrow"></span>
                    </div>
                    <div class="form-group">
                        <label for="nam_sinh" class="form-label">NÄƒm sinh:<span class="required-star">*</span></label>
                        <input type="number" id="nam_sinh" name="nam_sinh" placeholder="NÄƒm sinh*" min="1900" max="2025" required>
                    </div>
                    <div class="form-group date-input-group">
                        <label for="ngay_kham" class="form-label">NgÃ y khÃ¡m:<span class="required-star">*</span></label>
                        <input type="date" id="ngay_kham" name="ngay_kham" required>
                        <span class="date-icon">ğŸ—“ï¸</span>
                    </div>
                    
                    <!-- Div Ä‘á»ƒ hiá»ƒn thá»‹ thÃ´ng bÃ¡o -->
                    <div id="formMessage" style="margin-bottom: 15px; text-align: center; font-weight: 600;"></div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" onclick="window.location.href='{% url 'pages:index' %}'">Há»§y</button>
                        <button type="reset" class="btn btn-reset">Nháº­p láº¡i</button>
                        <button type="submit" class="btn btn-register-submit">ÄÄƒng kÃ½</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- === SCRIPT === -->
    <script>
        document.getElementById('registerForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const form = event.target;
            const formMessage = document.getElementById('formMessage');
            const submitButton = form.querySelector('button[type="submit"]');

            formMessage.textContent = 'Äang xá»­ lÃ½...';
            formMessage.style.color = 'black';
            submitButton.disabled = true;

            const formData = new FormData(form);
            const data = {
                ho_ten: formData.get('ho_ten'),
                dia_chi: formData.get('dia_chi'),
                gioi_tinh: formData.get('gioi_tinh'),
                nam_sinh: formData.get('nam_sinh'),
                ngay_kham: formData.get('ngay_kham'),
            };

            try {
                const response = await fetch('/api/register-appointment/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    },
                    body: JSON.stringify(data),
                });

                const responseData = await response.json();

                if (response.ok) {
                    formMessage.innerHTML = `ÄÄƒng kÃ½ thÃ nh cÃ´ng!<br>MÃ£ lá»‹ch khÃ¡m cá»§a báº¡n lÃ : <strong>${responseData.ma_lich_kham}</strong>`;
                    formMessage.style.color = 'green';
                    form.reset(); // XÃ³a cÃ¡c trÆ°á»ng Ä‘Ã£ nháº­p
                } else {
                    let errorMessage = 'ÄÃ£ cÃ³ lá»—i xáº£y ra. Vui lÃ²ng kiá»ƒm tra láº¡i.';
                    if (typeof responseData === 'object') {
                        // Lá»—i tá»« serializer, cÃ³ thá»ƒ lÃ  "NgÃ y Ä‘Ã£ Ä‘áº§y"
                        errorMessage = Object.values(responseData).flat().join(' ');
                    } else if (responseData.detail) {
                        errorMessage = responseData.detail;
                    }
                    formMessage.textContent = errorMessage;
                    formMessage.style.color = 'red';
                }

            } catch (error) {
                console.error('Lá»—i khi Ä‘Äƒng kÃ½ khÃ¡m bá»‡nh:', error);
                formMessage.textContent = 'Lá»—i káº¿t ná»‘i Ä‘áº¿n server.';
                formMessage.style.color = 'red';
            } finally {
                submitButton.disabled = false;
            }
        });

        // Set giÃ¡ trá»‹ máº·c Ä‘á»‹nh cho Ã´ ngÃ y khÃ¡m lÃ  ngÃ y hÃ´m nay
        document.getElementById('ngay_kham').valueAsDate = new Date();
    </script>
</body>
</html>